

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Lua &mdash; envoy 1.16.0-3e77a2 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="OAuth2" href="oauth2_filter.html" />
    <link rel="prev" title="本地限流" href="local_rate_limit_filter.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.16.0-3e77a2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">关于文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/intro.html">介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">开始</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/install.html">构建和安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">版本历史</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../configuration.html">配置参考</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../overview/overview.html">概览</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../listeners/listeners.html">监听器</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../http.html">HTTP</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../http_conn_man/http_conn_man.html">HTTP 连接管理器</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="http_filters.html">HTTP 过滤器</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="adaptive_concurrency_filter.html">自适应并发</a></li>
<li class="toctree-l4"><a class="reference internal" href="admission_control_filter.html">准入控制</a></li>
<li class="toctree-l4"><a class="reference internal" href="aws_lambda_filter.html">AWS Lambda</a></li>
<li class="toctree-l4"><a class="reference internal" href="aws_request_signing_filter.html">AWS 请求签名</a></li>
<li class="toctree-l4"><a class="reference internal" href="buffer_filter.html">缓冲区</a></li>
<li class="toctree-l4"><a class="reference internal" href="cdn_loop_filter.html">CDN-Loop 头部</a></li>
<li class="toctree-l4"><a class="reference internal" href="compressor_filter.html">压缩器</a></li>
<li class="toctree-l4"><a class="reference internal" href="cors_filter.html">CORS</a></li>
<li class="toctree-l4"><a class="reference internal" href="csrf_filter.html">CSRF</a></li>
<li class="toctree-l4"><a class="reference internal" href="decompressor_filter.html">解压缩器</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamic_forward_proxy_filter.html">动态转发代理</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamodb_filter.html">DynamoDB</a></li>
<li class="toctree-l4"><a class="reference internal" href="ext_authz_filter.html">外部授权</a></li>
<li class="toctree-l4"><a class="reference internal" href="fault_filter.html">故障注入</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_http1_bridge_filter.html">gRPC HTTP/1.1 桥接</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_http1_reverse_bridge_filter.html">gRPC HTTP/1.1 反向桥接</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_json_transcoder_filter.html">gRPC-JSON 转码器</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_stats_filter.html">gRPC 统计</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_web_filter.html">gRPC-Web</a></li>
<li class="toctree-l4"><a class="reference internal" href="gzip_filter.html">Gzip</a></li>
<li class="toctree-l4"><a class="reference internal" href="health_check_filter.html">健康检查</a></li>
<li class="toctree-l4"><a class="reference internal" href="header_to_metadata_filter.html">Envoy Header-To-Metadata 过滤器</a></li>
<li class="toctree-l4"><a class="reference internal" href="ip_tagging_filter.html">IP 标记</a></li>
<li class="toctree-l4"><a class="reference internal" href="jwt_authn_filter.html">JWT 认证</a></li>
<li class="toctree-l4"><a class="reference internal" href="local_rate_limit_filter.html">本地限流</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="oauth2_filter.html">OAuth2</a></li>
<li class="toctree-l4"><a class="reference internal" href="on_demand_updates_filter.html">按需更新 VHDS 和 S/RDS</a></li>
<li class="toctree-l4"><a class="reference internal" href="original_src_filter.html">请求源</a></li>
<li class="toctree-l4"><a class="reference internal" href="rate_limit_filter.html">限流</a></li>
<li class="toctree-l4"><a class="reference internal" href="rbac_filter.html">基于角色的访问控制（RBAC）过滤器</a></li>
<li class="toctree-l4"><a class="reference internal" href="router_filter.html">路由器</a></li>
<li class="toctree-l4"><a class="reference internal" href="squash_filter.html">Squash</a></li>
<li class="toctree-l4"><a class="reference internal" href="tap_filter.html">Tap</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../upstream/upstream.html">上游集群</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../observability/observability.html">可观测性</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/security.html">安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/operations.html">操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_features/other_features.html">其他特性</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_protocols/other_protocols.html">其他协议</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../advanced/advanced.html">高级配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../best_practices/best_practices.html">配置最佳实践</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">操作和管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">针对特定用例对 Envoy 进行扩展</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../configuration.html">配置参考</a> &raquo;</li>
        
          <li><a href="../http.html">HTTP</a> &raquo;</li>
        
          <li><a href="http_filters.html">HTTP 过滤器</a> &raquo;</li>
        
      <li>Lua</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/configuration/http/http_filters/lua_filter.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="lua">
<span id="config-http-filters-lua"></span><h1>Lua<a class="headerlink" href="#lua" title="Permalink to this headline">¶</a></h1>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>默认情况下构建出的 Envoy 不会提供以共享库方式安装 Lua 模块时需要的 symbols。但是 Envoy 可以按支持提供 symbols 的方式进行构建。请查看 <a class="reference external" href="https://github.com/envoyproxy/envoy/blob/3e77a2b8179d0dca27d8f058c3dbe3fded28c6df/bazel/README.md">Bazel 文档</a> 获取更多信息。</p>
</div>
<div class="section" id="id1">
<h2>概述<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>HTTP Lua 过滤器允许在请求和响应流期间运行 <a class="reference external" href="https://www.lua.org/">Lua</a> 脚本。<a class="reference external" href="https://luajit.org/">LuaJIT</a> 作为运行时使用，因此，支持的 Lua 版本主要是 5.1，同时也包括部分 5.2 的特性。查看 <a class="reference external" href="https://luajit.org/extensions.html">LuaJIT 文档</a> 获取更多详情。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference external" href="https://github.com/moonjit/moonjit/">moonjit</a> 是 LuaJIT 开发的延续，它支持了更多的 5.2 特性和额外的结构。可以使用如下 bazel 选项构建支持 moonjit 的 Envoy： <code class="docutils literal notranslate"><span class="pre">--//source/extensions/filters/common/lua:moonjit=1</span></code>。</p>
</div>
<p>过滤器和 Lua 支持的高层设计如下：</p>
<ul class="simple">
<li><p>所有的 Lua 环境都是 <a class="reference internal" href="../../../intro/arch_overview/intro/threading_model.html#arch-overview-threading"><span class="std std-ref">每个工作线程内的</span></a>。这意味着不存在真正的全局数据。在加载时创建和填充的所有全局变量都将在每个工作线程中独立展示。将来可能通过 API 添加真正的全局支持。</p></li>
<li><p>所有的脚本都以协程方式运行。这意味着即便它们可能执行复杂的异步任务，但它们也是按照同步的方式编写。这使得脚本实际上更容易编写。Envoy 通过一组 API 执行所有的网络/异步处理。Envoy 将适当地暂停脚本地执行，并在异步任务完成后继续执行脚本。</p></li>
<li><p><strong>不要在脚本中执行阻塞操作。</strong> Envoy API 用于所有的 IO，所以这对性能至关重要。</p></li>
</ul>
</div>
<div class="section" id="id4">
<h2>当前支持的高级特性<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p><strong>注意：</strong> 随着生产中使用该过滤器，预计该列表会随着时间的推移而拓展。API 表层保持精简。目的是使脚本尽可能简单和编写安全。非常复杂或高性能的使用场景应当使用原生的 C++ 过滤器 API。</p>
<ul class="simple">
<li><p>在流式传输的请求流和/或响应流中检查头部、正文和尾部。</p></li>
<li><p>修改头部和尾部。</p></li>
<li><p>阻塞并缓存整个请求/响应正文以进行检查。</p></li>
<li><p>对上游主机执行出站异步 HTTP 调用。可以在缓冲正文数据的同时执行此类调用，以便在调用完成时可以修改上游头部。</p></li>
<li><p>执行直接响应并跳过后续的过滤器迭代。例如，脚本可以向上游发起 HTTP 身份认证调用，然后直接响应 403 响应码。</p></li>
</ul>
</div>
<div class="section" id="id5">
<h2>配置<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="../../../api-v3/extensions/filters/http/lua/v3/lua.proto.html#envoy-v3-api-msg-extensions-filters-http-lua-v3-lua"><span class="std std-ref">v3 API 参考</span></a></p></li>
<li><p>此过滤器应使用配置名称 <em>envoy.filters.http.lua</em>。</p></li>
</ul>
<p>配置仅包含 <a class="reference internal" href="../../../api-v3/extensions/filters/http/lua/v3/lua.proto.html#envoy-v3-api-field-extensions-filters-http-lua-v3-lua-inline-code"><span class="std std-ref">inline_code</span></a> 的 Lua HTTP 过滤器的简单示例如下：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.filters.http.lua</span>
<span class="nt">typed_config</span><span class="p">:</span>
  <span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua</span>
  <span class="nt">inline_code</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">-- Called on the request path.</span>
    <span class="no">function envoy_on_request(request_handle)</span>
      <span class="no">-- Do something.</span>
    <span class="no">end</span>
    <span class="no">-- Called on the response path.</span>
    <span class="no">function envoy_on_response(response_handle)</span>
      <span class="no">-- Do something.</span>
    <span class="no">end</span>
</pre></div>
</div>
<p>默认情况下，定义在 <code class="docutils literal notranslate"><span class="pre">inline_code</span></code> 中的 Lua 脚本会被认定为 <code class="docutils literal notranslate"><span class="pre">GLOBAL</span></code> 脚本。Envoy 将会在每个 HTTP 请求中执行该脚本。</p>
</div>
<div class="section" id="id6">
<h2>基于每条路由的配置<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<p>通过在虚拟主机、路由或加权集群上提供 <a class="reference internal" href="../../../api-v3/extensions/filters/http/lua/v3/lua.proto.html#envoy-v3-api-msg-extensions-filters-http-lua-v3-luaperroute"><span class="std std-ref">LuaPerRoute</span></a> 配置，还可以基于每条路由禁用或覆盖 Lua HTTP 过滤器。</p>
<p>LuaPerRoute 提供了两种覆盖 <cite>GLOBAL</cite> Lua 脚本的方式：</p>
<ul class="simple">
<li><p>通过提供一个与已定义的 <a class="reference internal" href="../../../api-v3/extensions/filters/http/lua/v3/lua.proto.html#envoy-v3-api-field-extensions-filters-http-lua-v3-lua-source-codes"><span class="std std-ref">命名 Lua 源码映射</span></a> 相关联的名称。</p></li>
<li><p>通过提供内联 <a class="reference internal" href="../../../api-v3/extensions/filters/http/lua/v3/lua.proto.html#envoy-v3-api-field-extensions-filters-http-lua-v3-luaperroute-source-code"><span class="std std-ref">源码</span></a> （这允许通过 RDS 发送代码）。</p></li>
</ul>
<p>给出以下 Lua 过滤器配置作为具体实例：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.filters.http.lua</span>
<span class="nt">typed_config</span><span class="p">:</span>
  <span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua</span>
  <span class="nt">inline_code</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">function envoy_on_request(request_handle)</span>
      <span class="no">-- 执行某些逻辑</span>
    <span class="no">end</span>
  <span class="nt">source_codes</span><span class="p">:</span>
    <span class="nt">hello.lua</span><span class="p">:</span>
      <span class="nt">inline_string</span><span class="p">:</span> <span class="p p-Indicator">|</span>
        <span class="no">function envoy_on_request(request_handle)</span>
          <span class="no">request_handle:logInfo(&quot;Hello World.&quot;)</span>
        <span class="no">end</span>
    <span class="nt">bye.lua</span><span class="p">:</span>
      <span class="nt">inline_string</span><span class="p">:</span> <span class="p p-Indicator">|</span>
        <span class="no">function envoy_on_response(response_handle)</span>
          <span class="no">response_handle:logInfo(&quot;Bye Bye.&quot;)</span>
        <span class="no">end</span>
</pre></div>
</div>
<p>可以通过 <a class="reference internal" href="../../../api-v3/extensions/filters/http/lua/v3/lua.proto.html#envoy-v3-api-msg-extensions-filters-http-lua-v3-luaperroute"><span class="std std-ref">LuaPerRoute</span></a> 配置在某些虚拟主机、路由或加权集群上禁用 HTTP Lua 过滤器，如下所示：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">per_filter_config</span><span class="p">:</span>
  <span class="nt">envoy.filters.http.lua</span><span class="p">:</span>
    <span class="nt">disabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>我们还可以通过在 LuaPerRoute 中指定名称来引用过滤器配置中的 Lua 脚本。<code class="docutils literal notranslate"><span class="pre">GLOBAL</span></code> Lua 脚本会被引用的脚本覆盖：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">per_filter_config</span><span class="p">:</span>
  <span class="nt">envoy.filters.http.lua</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">hello.lua</span>
</pre></div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p><code class="docutils literal notranslate"><span class="pre">GLOBAL</span></code> 作为 <a class="reference internal" href="../../../api-v3/extensions/filters/http/lua/v3/lua.proto.html#envoy-v3-api-field-extensions-filters-http-lua-v3-lua-inline-code"><span class="std std-ref">Lua.inline_code</span></a> 中的保留名称。因此，请勿使用 <code class="docutils literal notranslate"><span class="pre">GLOBAL</span></code> 作为其他 Lua 脚本的名称。</p>
</div>
<p>或者我们可以直接在 LuaPerRoute 中定义一个新的脚本，以覆盖 <cite>GLOBAL</cite> Lua 脚本，如下所示：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">per_filter_config</span><span class="p">:</span>
  <span class="nt">envoy.filters.http.lua</span><span class="p">:</span>
    <span class="nt">source_code</span><span class="p">:</span>
      <span class="nt">inline_string</span><span class="p">:</span> <span class="p p-Indicator">|</span>
        <span class="no">function envoy_on_response(response_handle)</span>
          <span class="no">response_handle:logInfo(&quot;Goodbye.&quot;)</span>
        <span class="no">end</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h2>脚本示例<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>本章节提供一些具体的 Lua 脚本示例，作为更友好的介绍和快速入门。更多的 API 支持详情请参考 <a class="reference internal" href="#config-http-filters-lua-stream-handle-api"><span class="std std-ref">流处理 API</span></a>。</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="c1">-- 在请求路径上调用。</span>
<span class="kr">function</span> <span class="nf">envoy_on_request</span><span class="p">(</span><span class="n">request_handle</span><span class="p">)</span>
  <span class="c1">-- 等待整个请求正文并添加正文大小到请求头部。</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;request_body_size&quot;</span><span class="p">,</span> <span class="n">request_handle</span><span class="p">:</span><span class="n">body</span><span class="p">():</span><span class="n">length</span><span class="p">())</span>
<span class="kr">end</span>

<span class="c1">-- 在响应路径上调用。</span>
<span class="kr">function</span> <span class="nf">envoy_on_response</span><span class="p">(</span><span class="n">response_handle</span><span class="p">)</span>
  <span class="c1">-- 等待整个响应正文并添加正文大小到响应头部。</span>
  <span class="n">response_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;response_body_size&quot;</span><span class="p">,</span> <span class="n">response_handle</span><span class="p">:</span><span class="n">body</span><span class="p">():</span><span class="n">length</span><span class="p">())</span>
  <span class="c1">-- 移除响应头部 ‘foo’</span>
  <span class="n">response_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">envoy_on_request</span><span class="p">(</span><span class="n">request_handle</span><span class="p">)</span>
  <span class="c1">-- 使用如下头部、正文和超时时间向上游主机发起 HTTP 调用。</span>
  <span class="kd">local</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">request_handle</span><span class="p">:</span><span class="n">httpCall</span><span class="p">(</span>
  <span class="s2">&quot;lua_cluster&quot;</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="p">[</span><span class="s2">&quot;:method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;:path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;:authority&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;lua_cluster&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;hello world&quot;</span><span class="p">,</span>
  <span class="mi">5000</span><span class="p">)</span>

  <span class="c1">-- 将来自 HTTP 调用的信息添加到过滤器链中即将发送的下一个过滤器上。</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;upstream_foo&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">])</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;upstream_body_size&quot;</span><span class="p">,</span> <span class="o">#</span><span class="n">body</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">envoy_on_request</span><span class="p">(</span><span class="n">request_handle</span><span class="p">)</span>
  <span class="c1">-- 发起 HTTP 调用。</span>
  <span class="kd">local</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">request_handle</span><span class="p">:</span><span class="n">httpCall</span><span class="p">(</span>
  <span class="s2">&quot;lua_cluster&quot;</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="p">[</span><span class="s2">&quot;:method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;:path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;:authority&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;lua_cluster&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;set-cookie&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;lang=lua; Path=/&quot;</span><span class="p">,</span> <span class="s2">&quot;type=binding; Path=/&quot;</span> <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">&quot;hello world&quot;</span><span class="p">,</span>
  <span class="mi">5000</span><span class="p">)</span>

  <span class="c1">-- 直接响应并设置 HTTP 调用的头部。不会迭代到后续的过滤器。</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">respond</span><span class="p">(</span>
    <span class="p">{[</span><span class="s2">&quot;:status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;403&quot;</span><span class="p">,</span>
     <span class="p">[</span><span class="s2">&quot;upstream_foo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]},</span>
    <span class="s2">&quot;nope&quot;</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">envoy_on_request</span><span class="p">(</span><span class="n">request_handle</span><span class="p">)</span>
  <span class="c1">-- 记录请求信息</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="s2">&quot;Authority: &quot;</span><span class="o">..</span><span class="n">request_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;:authority&quot;</span><span class="p">))</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="s2">&quot;Method: &quot;</span><span class="o">..</span><span class="n">request_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;:method&quot;</span><span class="p">))</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="s2">&quot;Path: &quot;</span><span class="o">..</span><span class="n">request_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;:path&quot;</span><span class="p">))</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">envoy_on_response</span><span class="p">(</span><span class="n">response_handle</span><span class="p">)</span>
  <span class="c1">-- 记录响应状态码</span>
  <span class="n">response_handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="s2">&quot;Status: &quot;</span><span class="o">..</span><span class="n">response_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;:status&quot;</span><span class="p">))</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>一个常见的使用场景是重写上游的响应正文，例如：上游发送了非 2xx 的 JSON 数据响应，但应用要求发送 HTML 页面到浏览器端。</p>
<p>有两种方式可以实现，第一种是通过 <cite>body()</cite> API。</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">envoy_on_response</span><span class="p">(</span><span class="n">response_handle</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">content_length</span> <span class="o">=</span> <span class="n">response_handle</span><span class="p">:</span><span class="n">body</span><span class="p">():</span><span class="n">setBytes</span><span class="p">(</span><span class="s2">&quot;&lt;html&gt;&lt;b&gt;Not Found&lt;b&gt;&lt;/html&gt;&quot;</span><span class="p">)</span>
  <span class="n">response_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;content-length&quot;</span><span class="p">,</span> <span class="n">content_length</span><span class="p">)</span>
  <span class="n">response_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;content-type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/html&quot;</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>或者，通过 <cite>bodyChunks()</cite> API，使 Envoy 跳过缓存上游的响应数据。</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">envoy_on_response</span><span class="p">(</span><span class="n">response_handle</span><span class="p">)</span>

  <span class="c1">-- 设置 content-length。</span>
  <span class="n">response_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;content-length&quot;</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
  <span class="n">response_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">():</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;content-type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/html&quot;</span><span class="p">)</span>

  <span class="kd">local</span> <span class="n">last</span>
  <span class="kr">for</span> <span class="n">chunk</span> <span class="kr">in</span> <span class="n">response_handle</span><span class="p">:</span><span class="n">bodyChunks</span><span class="p">()</span> <span class="kr">do</span>
    <span class="c1">-- 清除每个接收到的响应正文数据块。</span>
    <span class="n">chunk</span><span class="p">:</span><span class="n">setBytes</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">chunk</span>
  <span class="kr">end</span>

  <span class="n">last</span><span class="p">:</span><span class="n">setBytes</span><span class="p">(</span><span class="s2">&quot;&lt;html&gt;&lt;b&gt;Not Found&lt;b&gt;&lt;/html&gt;&quot;</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
</div>
<div class="section" id="config-http-filters-lua-stream-handle-api">
<span id="id8"></span><h2>完整示例<a class="headerlink" href="#config-http-filters-lua-stream-handle-api" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/envoyproxy/envoy/blob/3e77a2b8179d0dca27d8f058c3dbe3fded28c6df//examples/lua">/examples/lua</a> 中提供了使用 Docker 的完整示例。</p>
</div>
<div class="section" id="api">
<h2>流处理 API<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h2>
<p>当 Envoy 加载了脚本中的配置时，它将执行脚本中定义的两个全局方法：</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">envoy_on_request</span><span class="p">(</span><span class="n">request_handle</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">envoy_on_response</span><span class="p">(</span><span class="n">response_handle</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>脚本中可以同时定义这些方法。请求路径中，Envoy 将会以协程方式运行 <em>envoy_on_request</em>，将处理方法传递到请求 API。在响应路径中，Envoy 将以协程方式运行 <em>envoy_on_response</em>，将处理方法传递到响应 API。</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>与 Envoy 的所有交互都要通过传递的流处理方法进行，这点至关重要。流处理方法中不应该指定任何全局变量，且不能在协程外部使用。如果处理方法被错误使用，Envoy 将使脚本失败。</p>
</div>
<p>支持如下的流处理方法：</p>
<div class="section" id="headers">
<h3>headers()<a class="headerlink" href="#headers" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">headers</span><span class="p">()</span>
</pre></div>
</div>
<p>返回流的头部。只要头部尚未被发送到头部链中的下一个过滤器，就可以对其进行修改。例如，在 <em>body()</em> 或 <em>httpCall()</em> 调用返回后它们可以被修改。如果在其他任何情况下修改头部，将使脚本失败。</p>
<p>返回一个 <a class="reference internal" href="#config-http-filters-lua-header-wrapper"><span class="std std-ref">头部对象</span></a>。</p>
</div>
<div class="section" id="body">
<h3>body()<a class="headerlink" href="#body" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">body</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">body</span><span class="p">()</span>
</pre></div>
</div>
<p>返回流的正文。此调用将导致 Envoy 暂停脚本的执行直到整个正文被接收到缓冲区中。注意所有的缓冲都必须遵守适当的流控制策略。Envoy 不会缓冲超出连接管理器所允许的多出数据。</p>
<p>返回一个 <a class="reference internal" href="#config-http-filters-lua-buffer-wrapper"><span class="std std-ref">缓冲对象</span></a>。</p>
</div>
<div class="section" id="bodychunks">
<h3>bodyChunks()<a class="headerlink" href="#bodychunks" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">bodyChunks</span><span class="p">()</span>
</pre></div>
</div>
<p>返回一个迭代器，可在所有接收到的正文块到达时用其进行迭代。在块与块之间 Envoy 将暂停执行脚本，但 <em>不会缓存</em> 它们。脚本可以用其检查流式传输的数据。</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">for</span> <span class="n">chunk</span> <span class="kr">in</span> <span class="n">request_handle</span><span class="p">:</span><span class="n">bodyChunks</span><span class="p">()</span> <span class="kr">do</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">log</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">chunk</span><span class="p">:</span><span class="n">length</span><span class="p">())</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>迭代器返回的每个块都是一个 <a class="reference internal" href="#config-http-filters-lua-buffer-wrapper"><span class="std std-ref">缓冲对象</span></a>。</p>
</div>
<div class="section" id="trailers">
<h3>trailers()<a class="headerlink" href="#trailers" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">trailers</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">trailers</span><span class="p">()</span>
</pre></div>
</div>
<p>返回流的尾部。如果没有尾部则可能返回 nil。尾部在被发送到下一个过滤器前是可以被修改的。</p>
<p>返回一个 <a class="reference internal" href="#config-http-filters-lua-header-wrapper"><span class="std std-ref">头部对象</span></a>。</p>
</div>
<div class="section" id="log">
<h3>log*()<a class="headerlink" href="#log" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">handle</span><span class="p">:</span><span class="n">logTrace</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logDebug</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logWarn</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logErr</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logCritical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
<p>使用 Envoy 的应用日志记录一条消息。<em>message</em> 是要记录的字符串。</p>
</div>
<div class="section" id="httpcall">
<h3>httpCall()<a class="headerlink" href="#httpcall" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">httpCall</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">asynchronous</span><span class="p">)</span>
</pre></div>
</div>
<p>向上游主机发起一个 HTTP 调用。<em>cluster</em> 是一个字符串，它映射到集群管理器中已配置的集群。<em>headers</em> 是要发送的键/值对表（值可以是字符串或者字符串表）。注意必须设置 <em>:method</em>、<em>:path</em> 和 <em>:authority</em> 头部。<em>body</em> 是一个可选的字符串，表示要发送的正文数据。<em>timeout</em> 是一个整型，用于指定调用的超时时间（毫秒单位）。</p>
<p><em>asynchronous</em> 是一个布尔型标记。如果 asynchronous 设置为 true，无论响应成功与否，Envoy 都会发出 HTTP 请求并继续。如果此标记设置为 false，或者没设置，Envoy 将暂停执行脚本直到调用完成或者发生错误。</p>
<p>返回的 <em>headers</em> 是指响应头部表。返回的 <em>body</em> 是指字符串响应正文，如果没有正文则为 nil。</p>
</div>
<div class="section" id="respond">
<h3>respond()<a class="headerlink" href="#respond" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">handle</span><span class="p">:</span><span class="n">respond</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
</pre></div>
</div>
<p>立即响应并且不再执行后续的过滤器迭代。此调用仅在请求流中生效。此外，仅当请求头部尚未传递到后续过滤器时，才可以响应。这意味着，以下 Lua 代码是无效的：</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">envoy_on_request</span><span class="p">(</span><span class="n">request_handle</span><span class="p">)</span>
  <span class="kr">for</span> <span class="n">chunk</span> <span class="kr">in</span> <span class="n">request_handle</span><span class="p">:</span><span class="n">bodyChunks</span><span class="p">()</span> <span class="kr">do</span>
    <span class="n">request_handle</span><span class="p">:</span><span class="n">respond</span><span class="p">(</span>
      <span class="p">{[</span><span class="s2">&quot;:status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;100&quot;</span><span class="p">},</span>
      <span class="s2">&quot;nope&quot;</span><span class="p">)</span>
  <span class="kr">end</span>
<span class="kr">end</span>
</pre></div>
</div>
<p><em>headers</em> 是要发送的键/值对表（值可以是字符串或者字符串表）。注意必须设置 <em>:status</em> 头部。<em>body</em> 是一个字符串，并提供了可选的响应正文，可能为 nil。</p>
</div>
<div class="section" id="metadata">
<h3>metadata()<a class="headerlink" href="#metadata" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">metadata</span><span class="p">()</span>
</pre></div>
</div>
<p>返回当前路由的整个元数据。注意元数据应在过滤器名称下指定，即 <em>envoy.filters.http.lua</em>。以下是 <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-msg-config-route-v3-route"><span class="std std-ref">路由条目</span></a> 中元数据的配置示例：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">filter_metadata</span><span class="p">:</span>
    <span class="nt">envoy.filters.http.lua</span><span class="p">:</span>
      <span class="nt">foo</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bar</span>
      <span class="nt">baz</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">bad</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">baz</span>
</pre></div>
</div>
<p>返回一个 <a class="reference internal" href="#config-http-filters-lua-metadata-wrapper"><span class="std std-ref">元数据对象</span></a>。</p>
</div>
<div class="section" id="streaminfo">
<h3>streamInfo()<a class="headerlink" href="#streaminfo" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">streamInfo</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">streamInfo</span><span class="p">()</span>
</pre></div>
</div>
<p>返回与当前请求相关的 <a class="reference external" href="https://github.com/envoyproxy/envoy/blob/3e77a2b8179d0dca27d8f058c3dbe3fded28c6df/include/envoy/stream_info/stream_info.h">信息</a>。</p>
<p>返回一个 <a class="reference internal" href="#config-http-filters-lua-stream-info-wrapper"><span class="std std-ref">流信息对象</span></a>。</p>
</div>
<div class="section" id="connection">
<h3>connection()<a class="headerlink" href="#connection" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">connection</span><span class="p">()</span>
</pre></div>
</div>
<p>返回当前请求的底层 <a class="reference external" href="https://github.com/envoyproxy/envoy/blob/3e77a2b8179d0dca27d8f058c3dbe3fded28c6df/include/envoy/network/connection.h">连接</a>。</p>
<p>返回一个 <a class="reference internal" href="#config-http-filters-lua-connection-wrapper"><span class="std std-ref">连接对象</span></a>。</p>
</div>
<div class="section" id="importpublickey">
<h3>importPublicKey()<a class="headerlink" href="#importpublickey" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">pubkey</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">importPublicKey</span><span class="p">(</span><span class="n">keyder</span><span class="p">,</span> <span class="n">keyderLength</span><span class="p">)</span>
</pre></div>
</div>
<p>返回 <a class="reference internal" href="#verify-signature"><span class="std std-ref">verifySignature</span></a> 所使用的用于验证数字签名的公共密钥。</p>
</div>
<div class="section" id="verifysignature">
<span id="verify-signature"></span><h3>verifySignature()<a class="headerlink" href="#verifysignature" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="nb">error</span> <span class="o">=</span> <span class="n">verifySignature</span><span class="p">(</span><span class="n">hashFunction</span><span class="p">,</span> <span class="n">pubkey</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">signatureLength</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataLength</span><span class="p">)</span>
</pre></div>
</div>
<p>使用提供的参数验证签名。<em>hashFunction</em> 是哈希方法变量，用于验证签名，支持 <em>SHA1</em>、<em>SHA224</em>、<em>SHA256</em>、<em>SHA384</em> 和 <em>SHA512</em>。<em>pubkey</em> 是公钥。<em>signature</em> 是要验证的签名。<em>signatureLength</em> 是签名的长度。<em>data</em> 是要执行哈希计算的内容。<em>dataLength</em> 是数据长度。</p>
<p>该方法返回一对值。如果第一个元素值为 <em>true</em>，第二个元素值将为空，表示签名已验证；否则，第二个元素将会存储错误信息。</p>
</div>
<div class="section" id="base64escape">
<span id="config-http-filters-lua-stream-handle-api-base64-escape"></span><h3>base64Escape()<a class="headerlink" href="#base64escape" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">base64_encoded</span> <span class="o">=</span> <span class="n">handle</span><span class="p">:</span><span class="n">base64Escape</span><span class="p">(</span><span class="s2">&quot;input string&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>将输入字符串按 base64 编码。这在转义二进制数据时很有用。</p>
</div>
</div>
<div class="section" id="config-http-filters-lua-header-wrapper">
<span id="id9"></span><h2>头部对象 API<a class="headerlink" href="#config-http-filters-lua-header-wrapper" title="Permalink to this headline">¶</a></h2>
<div class="section" id="add">
<h3>add()<a class="headerlink" href="#add" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">headers</span><span class="p">:</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>添加一个头部。<em>key</em> 是提供头部键的字符串。<em>value</em> 是提供头部值的字符串。</p>
</div>
<div class="section" id="get">
<h3>get()<a class="headerlink" href="#get" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">headers</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
<p>获取一个头部。<em>key</em> 是提供头部键的字符串。返回头部值字符串或者 nil（如果头部不存在）。</p>
</div>
<div class="section" id="pairs">
<h3>__pairs()<a class="headerlink" href="#pairs" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="kr">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span> <span class="kr">do</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>迭代每个头部。<em>key</em> 是提供头部键的字符串。<em>value</em> 是提供头部值的字符串。</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>在当前的实现中，头部在迭代的过程中不能被修改。此外，如果有必要在迭代后修改头部。则必须首先完成迭代。这意外着不能使用 <cite>break</cite> 或者其他方法提前退出循环。将来的实现会更加灵活。</p>
</div>
</div>
<div class="section" id="remove">
<h3>remove()<a class="headerlink" href="#remove" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">headers</span><span class="p">:</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
<p>移除一个头部。<em>key</em> 提供要移除的头部键。</p>
</div>
<div class="section" id="replace">
<h3>replace()<a class="headerlink" href="#replace" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">headers</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>替换一个头部。<em>key</em> 是提供头部键的字符串。<em>value</em> 是提供头部值的字符串。如果头部不存在则会按照 <em>add()</em> 方法添加头部。</p>
</div>
</div>
<div class="section" id="config-http-filters-lua-buffer-wrapper">
<span id="id10"></span><h2>缓冲区 API<a class="headerlink" href="#config-http-filters-lua-buffer-wrapper" title="Permalink to this headline">¶</a></h2>
<div class="section" id="length">
<h3>length()<a class="headerlink" href="#length" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">size</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">:</span><span class="n">length</span><span class="p">()</span>
</pre></div>
</div>
<p>获取缓冲区的字节大小。返回一个整型。</p>
</div>
<div class="section" id="getbytes">
<h3>getBytes()<a class="headerlink" href="#getbytes" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">buffer</span><span class="p">:</span><span class="n">getBytes</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
</pre></div>
</div>
<p>获取缓冲区中的字节。默认情况下，Envoy 不会将所有缓冲区字节复制到 Lua，这将导致缓冲区段被复制。<em>index</em> 是提供缓冲区复制起始下标的整型。<em>length</em> 是提供缓冲区复制长度的整型。<em>index</em> 加 <em>length</em> 必须小于缓冲区长度。</p>
</div>
<div class="section" id="setbytes">
<span id="config-http-filters-lua-buffer-wrapper-api-set-bytes"></span><h3>setBytes()<a class="headerlink" href="#setbytes" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">buffer</span><span class="p">:</span><span class="n">setBytes</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</pre></div>
</div>
<p>使用输入字符串设置缓冲区的封装内容。</p>
</div>
</div>
<div class="section" id="config-http-filters-lua-metadata-wrapper">
<span id="id11"></span><h2>元数据对象 API<a class="headerlink" href="#config-http-filters-lua-metadata-wrapper" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id12">
<h3>get()<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">metadata</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
<p>获取一条元数据。<em>key</em> 是提供元数据键的字符串。返回给定元数据键的相应值。值的类型可以是：<em>nil</em>、<em>boolean</em>、<em>number</em>、<em>string</em> 和 <em>table</em>。</p>
</div>
<div class="section" id="id13">
<h3>__pairs()<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="kr">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="kr">do</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>迭代每个 <em>metadata</em> 条目。<em>key</em> 是提供 <em>metadata</em> 键的字符串。<em>value</em> 是 <em>metadata</em> 条目的值。</p>
</div>
</div>
<div class="section" id="config-http-filters-lua-stream-info-wrapper">
<span id="id14"></span><h2>流信息对象 API<a class="headerlink" href="#config-http-filters-lua-stream-info-wrapper" title="Permalink to this headline">¶</a></h2>
<div class="section" id="protocol">
<h3>protocol()<a class="headerlink" href="#protocol" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">streamInfo</span><span class="p">:</span><span class="n">protocol</span><span class="p">()</span>
</pre></div>
</div>
<p>返回当前请求所使用的表示 <a class="reference external" href="https://github.com/envoyproxy/envoy/blob/3e77a2b8179d0dca27d8f058c3dbe3fded28c6df/include/envoy/http/protocol.h">HTTP 协议</a> 的字符串。可能的值为：<em>HTTP/1.0</em>、<em>HTTP/1.1</em> 和 <em>HTTP/2</em>。</p>
</div>
<div class="section" id="dynamicmetadata">
<h3>dynamicMetadata()<a class="headerlink" href="#dynamicmetadata" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">streamInfo</span><span class="p">:</span><span class="n">dynamicMetadata</span><span class="p">()</span>
</pre></div>
</div>
<p>返回一个 <a class="reference internal" href="#config-http-filters-lua-stream-info-dynamic-metadata-wrapper"><span class="std std-ref">动态元数据对象</span></a>。</p>
</div>
<div class="section" id="downstreamsslconnection">
<h3>downstreamSslConnection()<a class="headerlink" href="#downstreamsslconnection" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">streamInfo</span><span class="p">:</span><span class="n">downstreamSslConnection</span><span class="p">()</span>
</pre></div>
</div>
<p>返回与当前 SSL 连接相关的 <a class="reference external" href="https://github.com/envoyproxy/envoy/blob/3e77a2b8179d0dca27d8f058c3dbe3fded28c6df/include/envoy/ssl/connection.h">信息</a>。</p>
<p>返回一个下游 <a class="reference internal" href="#config-http-filters-lua-ssl-socket-info"><span class="std std-ref">SSL 连接信息对象</span></a>。</p>
</div>
</div>
<div class="section" id="config-http-filters-lua-stream-info-dynamic-metadata-wrapper">
<span id="id15"></span><h2>动态元数据对象 API<a class="headerlink" href="#config-http-filters-lua-stream-info-dynamic-metadata-wrapper" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id16">
<h3>get()<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">dynamicMetadata</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">filterName</span><span class="p">)</span>

<span class="c1">-- 从返回的表中获取一个值。</span>
<span class="n">dynamicMetadata</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">filterName</span><span class="p">)[</span><span class="n">key</span><span class="p">]</span>
</pre></div>
</div>
<p>从动态元数据结构中获取一个条目。<em>filterName</em> 是提供过滤器名称的字符串。例如 <em>envoy.lb</em>。返回与给定 <em>filterName</em> 对应的 <em>table</em>。</p>
</div>
<div class="section" id="set">
<h3>set()<a class="headerlink" href="#set" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">dynamicMetadata</span><span class="p">:</span><span class="n">set</span><span class="p">(</span><span class="n">filterName</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>设置 <em>filterName</em> 的元数据键值对。<em>filterName</em> 是指定目标过滤器名称的键，例如 <em>envoy.lb</em>。<em>key</em> 的类型为 <em>string</em>。<em>value</em> 的值类型是可以映射到元数据的任何 Lua 类型：<em>table</em>、<em>numeric</em>、<em>boolean</em>、<em>string</em> 或 <em>nil</em>。当使用 <em>table</em> 作为参数时，其键只能是 <em>string</em> 或 <em>numeric</em>。</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">envoy_on_request</span><span class="p">(</span><span class="n">request_handle</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">request_handle</span><span class="p">:</span><span class="n">headers</span><span class="p">()</span>
  <span class="n">request_handle</span><span class="p">:</span><span class="n">streamInfo</span><span class="p">():</span><span class="n">dynamicMetadata</span><span class="p">():</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;envoy.filters.http.lua&quot;</span><span class="p">,</span> <span class="s2">&quot;request.info&quot;</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">auth</span><span class="p">:</span> <span class="n">headers</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;authorization&quot;</span><span class="p">),</span>
    <span class="n">token</span><span class="p">:</span> <span class="n">headers</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x-request-token&quot;</span><span class="p">),</span>
  <span class="p">})</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">envoy_on_response</span><span class="p">(</span><span class="n">response_handle</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">response_handle</span><span class="p">:</span><span class="n">streamInfo</span><span class="p">():</span><span class="n">dynamicMetadata</span><span class="p">():</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;envoy.filters.http.lua&quot;</span><span class="p">)[</span><span class="s2">&quot;request.info&quot;</span><span class="p">]</span>
  <span class="n">response_handle</span><span class="p">:</span><span class="n">logInfo</span><span class="p">(</span><span class="s2">&quot;Auth: &quot;</span><span class="o">..</span><span class="n">meta</span><span class="p">.</span><span class="n">auth</span><span class="o">..</span><span class="s2">&quot;, token: &quot;</span><span class="o">..</span><span class="n">meta</span><span class="p">.</span><span class="n">token</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
</div>
<div class="section" id="id17">
<h3>__pairs()<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="kr">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">dynamicMetadata</span><span class="p">)</span> <span class="kr">do</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>迭代每个 <em>dynamicMetadata</em> 条目。 <em>key</em> 是提供 <em>dynamicMetadata</em> 键的字符串。<em>value</em> 是一个 <em>dynamicMetadata</em> 条目值。</p>
</div>
</div>
<div class="section" id="config-http-filters-lua-connection-wrapper">
<span id="id18"></span><h2>连接对象 API<a class="headerlink" href="#config-http-filters-lua-connection-wrapper" title="Permalink to this headline">¶</a></h2>
<div class="section" id="ssl">
<h3>ssl()<a class="headerlink" href="#ssl" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">if</span> <span class="n">connection</span><span class="p">:</span><span class="n">ssl</span><span class="p">()</span> <span class="o">==</span> <span class="kc">nil</span> <span class="kr">then</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;plain&quot;</span><span class="p">)</span>
<span class="kr">else</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;secure&quot;</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>当连接安全时返回 <a class="reference external" href="https://github.com/envoyproxy/envoy/blob/3e77a2b8179d0dca27d8f058c3dbe3fded28c6df/include/envoy/ssl/connection.h">SSL 连接</a> 对象，否则返回 <em>nil</em>。</p>
<p>返回一个 <a class="reference internal" href="#config-http-filters-lua-ssl-socket-info"><span class="std std-ref">SSL 连接信息对象</span></a>。</p>
</div>
</div>
<div class="section" id="ssl-api">
<span id="config-http-filters-lua-ssl-socket-info"></span><h2>SSL 连接对象 API<a class="headerlink" href="#ssl-api" title="Permalink to this headline">¶</a></h2>
<div class="section" id="peercertificatepresented">
<h3>peerCertificatePresented()<a class="headerlink" href="#peercertificatepresented" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">if</span> <span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">peerCertificatePresented</span><span class="p">()</span> <span class="kr">then</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;peer certificate is presented&quot;</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>返回布尔值，表示是否存在对等证书。</p>
</div>
<div class="section" id="peercertificatevalidated">
<h3>peerCertificateValidated()<a class="headerlink" href="#peercertificatevalidated" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">if</span> <span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">peerCertificateVaidated</span><span class="p">()</span> <span class="kr">then</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;peer certificate is valiedated&quot;</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>返回布尔值，表示对等证书是否已验证。</p>
</div>
<div class="section" id="urisanlocalcertificate">
<h3>uriSanLocalCertificate()<a class="headerlink" href="#urisanlocalcertificate" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="c1">-- 例如，uriSanLocalCertificate 包含 {&quot;san1&quot;, &quot;san2&quot;}</span>
<span class="kd">local</span> <span class="n">certs</span> <span class="o">=</span> <span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">uriSanLocalCertificate</span><span class="p">()</span>

<span class="c1">-- 下方打印 san1,san2</span>
<span class="n">handle</span><span class="p">:</span><span class="n">logTrace</span><span class="p">(</span><span class="nb">table.concat</span><span class="p">(</span><span class="n">certs</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>以表形式返回本地证书中 SAN 字段的 URIs。如果没有本地证书、SAN 字段或 URI SAN 条目则返回一个空表。</p>
</div>
<div class="section" id="sha256peercertificatedigest">
<h3>sha256PeerCertificateDigest()<a class="headerlink" href="#sha256peercertificatedigest" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">sha256PeerCertificateDigest</span><span class="p">()</span>
</pre></div>
</div>
<p>返回对等证书的 SHA256 摘要。如果没有可用于 TLS（非mTLS） 连接的对等证书则返回 <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code>。</p>
</div>
<div class="section" id="serialnumberpeercertificate">
<h3>serialNumberPeerCertificate()<a class="headerlink" href="#serialnumberpeercertificate" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">serialNumberPeerCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>返回对等证书的序列号字段。如果没有对等证书或序列号则返回 <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code>。</p>
</div>
<div class="section" id="issuerpeercertificate">
<h3>issuerPeerCertificate()<a class="headerlink" href="#issuerpeercertificate" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">issuerPeerCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>以 RFC 2253 格式返回对等证书的颁发者字段。如果没有对等证书或颁发者则返回 <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code>。</p>
</div>
<div class="section" id="subjectpeercertificate">
<h3>subjectPeerCertificate()<a class="headerlink" href="#subjectpeercertificate" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">subjectPeerCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>以 RFC 2253 格式返回对等证书的主题字段。如果没有对等证书或主题则返回 <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code>。</p>
</div>
<div class="section" id="urisanpeercertificate">
<h3>uriSanPeerCertificate()<a class="headerlink" href="#urisanpeercertificate" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">uriSanPeerCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>以表形式返回对等证书中 SAN 字段的 URIs。如果没有对等证书、SAN 字段或 URL SAN 条目则返回空表。</p>
</div>
<div class="section" id="subjectlocalcertificate">
<h3>subjectLocalCertificate()<a class="headerlink" href="#subjectlocalcertificate" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">subjectLocalCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>以 RFC 2253 格式返回本地证书的主题字段。如果没有本地证书或主题则返回 <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code>。</p>
</div>
<div class="section" id="urlencodedpemencodedpeercertificate">
<h3>urlEncodedPemEncodedPeerCertificate()<a class="headerlink" href="#urlencodedpemencodedpeercertificate" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">urlEncodedPemEncodedPeerCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>返回完整的对等证书（包括证书叶）的 URL 编码的 PEM 编码表示。如果没有对等证书或编码失败则返回 <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code>。</p>
</div>
<div class="section" id="urlencodedpemencodedpeercertificatechain">
<h3>urlEncodedPemEncodedPeerCertificateChain()<a class="headerlink" href="#urlencodedpemencodedpeercertificatechain" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">urlEncodedPemEncodedPeerCertificateChain</span><span class="p">()</span>
</pre></div>
</div>
<p>返回完整的对等证书链（包括证书叶）的 URL 编码的 PEM 编码表示。如果没有对等证书或编码失败则返回 <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code>。</p>
</div>
<div class="section" id="dnssanspeercertificate">
<h3>dnsSansPeerCertificate()<a class="headerlink" href="#dnssanspeercertificate" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">dnsSansPeerCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>以表形式返回对等证书中 SAN 字段的 DNS 条目。如果没有对等证书、SAN 字段或 DNS SAN 条目则返回空表。</p>
</div>
<div class="section" id="dnssanslocalcertificate">
<h3>dnsSansLocalCertificate()<a class="headerlink" href="#dnssanslocalcertificate" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">dnsSansLocalCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>以表形式返回本地证书中 SAN 字段的 DNS 条目。如果没有对等证书、SAN 字段或 DNS SAN 条目则返回空表。</p>
</div>
<div class="section" id="validfrompeercertificate">
<h3>validFromPeerCertificate()<a class="headerlink" href="#validfrompeercertificate" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">validFromPeerCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>返回对等证书签发并生效的时间（以秒为单位的时间戳）。如果没有对等证书则返回 <code class="docutils literal notranslate"><span class="pre">0</span></code>。</p>
<p>在 Lua 中，我们通常使用 <code class="docutils literal notranslate"><span class="pre">os.time(os.date(&quot;!*t&quot;))</span></code> 获取当前的时间戳（以秒为单位）。</p>
</div>
<div class="section" id="expirationpeercertificate">
<h3>expirationPeerCertificate()<a class="headerlink" href="#expirationpeercertificate" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">validFromPeerCertificate</span><span class="p">()</span>
</pre></div>
</div>
<p>返回对等证书过期并失效的时间（以秒为单位的时间戳）。如果没有对等证书则返回 <code class="docutils literal notranslate"><span class="pre">0</span></code>。</p>
<p>在 Lua 中，我们通常使用 <code class="docutils literal notranslate"><span class="pre">os.time(os.date(&quot;!*t&quot;))</span></code> 获取当前的时间戳（以秒为单位）。</p>
</div>
<div class="section" id="sessionid">
<h3>sessionId()<a class="headerlink" href="#sessionid" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">sessionId</span><span class="p">()</span>
</pre></div>
</div>
<p>返回 RFC 5246 中定义的十六进制编码的 TLS 会话 ID。</p>
</div>
<div class="section" id="ciphersuiteid">
<h3>ciphersuiteId()<a class="headerlink" href="#ciphersuiteid" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">ciphersuiteId</span><span class="p">()</span>
</pre></div>
</div>
<p>返回已建立的 TLS 连接中所使用的密码标准 ID（十六进制编码）。如果当前没有已商定的密码套件则返回 <code class="docutils literal notranslate"><span class="pre">&quot;0xffff&quot;</span></code>。</p>
</div>
<div class="section" id="ciphersuitestring">
<h3>ciphersuiteString()<a class="headerlink" href="#ciphersuitestring" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">ciphersuiteString</span><span class="p">()</span>
</pre></div>
</div>
<p>返回已建立的 TLS 连接中所使用的密码套件的 OpenSSL 名称。如果当前没有已商定的密码套件则返回 <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code>。</p>
</div>
<div class="section" id="tlsversion">
<h3>tlsVersion()<a class="headerlink" href="#tlsversion" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">downstreamSslConnection</span><span class="p">:</span><span class="n">urlEncodedPemEncodedPeerCertificateChain</span><span class="p">()</span>
</pre></div>
</div>
<p>返回已建立的 TLS 连接中使用的 TLS 版本（例如 TLSv1.2、TLSv1.3）。</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="oauth2_filter.html" class="btn btn-neutral float-right" title="OAuth2" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="local_rate_limit_filter.html" class="btn btn-neutral float-left" title="本地限流" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2016-2021, Envoy Project Authors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>